# å…³äºMt_Express
ä½¿ç”¨expressäºŒæ¬¡å¼€å‘çš„æœåŠ¡æ¡†æ¶ï¼Œç”¨äºçº¯åç«¯åº”ç”¨æœåŠ¡ã€‚ä»…ç”¨äºå­¦ä¹ è®¨è®º

nodejsç‰ˆæœ¬è¦æ±‚ï¼š`18 < n`ã€‚

## âš ï¸ é‡è¦æç¤ºï¼šè¿è¡Œè®¸å¯éªŒè¯

æœ¬é¡¹ç›®å®æ–½äº†**è¿è¡Œè®¸å¯éªŒè¯æœºåˆ¶**ã€‚ç¨‹åºå¯åŠ¨å‰ä¼šè‡ªåŠ¨æ£€æŸ¥ `LICENSE` æ–‡ä»¶ï¼š

- **è®¸å¯åè®®**: GNU General Public License v3.0 (GPL-3.0)
- **é¡¹ç›®ä»“åº“**: https://github.com/MtSatou/MTE
- **ä½œè€…**: MtSatou

### è®¸å¯éªŒè¯è¯´æ˜

âœ… **ç¨‹åºå¯åŠ¨æ—¶ä¼šéªŒè¯**:
1. LICENSE æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•
2. æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å« GPL åè®®æ ‡è¯†
3. æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å«é¡¹ç›®ä»“åº“åœ°å€

âŒ **å¦‚æœéªŒè¯å¤±è´¥**:
- ç¨‹åºå°†æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢è¿è¡Œ
- è¯·ä» [GitHubä»“åº“](https://github.com/MtSatou/MTE) è·å–å®Œæ•´çš„ LICENSE æ–‡ä»¶

ğŸ“– **è¯¦ç»†è¯´æ˜**: æŸ¥çœ‹ [LICENSE_CHECK.md](./LICENSE_CHECK.md) äº†è§£æ›´å¤šä¿¡æ¯

âš ï¸ **è¯·å‹¿åˆ é™¤æˆ–ä¿®æ”¹ LICENSE æ–‡ä»¶**ï¼Œå¦åˆ™ç¨‹åºå°†æ— æ³•å¯åŠ¨ï¼

## åŠŸèƒ½ç‰¹æ€§

1. **WS**ï¼šæ”¯æŒwsé“¾æ¥ï¼Œå®ç°å¹¿æ’­/å¿ƒè·³æ£€æµ‹/æˆ¿é—´åŠŸèƒ½
2. **Tokené‰´æƒ**ï¼šå†…ç½®Tokené‰´æƒï¼Œå®ç°APIæƒé™æ‹¦æˆª
3. **æ–‡ä»¶ä¸Šä¼ **ï¼šæ”¯æŒæ–‡ä»¶ä¸Šä¼ 
4. **é‚®ä»¶æ”¯æŒ**ï¼šæ”¯æŒå‘é€é‚®ä»¶ï¼Œéœ€é…ç½®é‚®ç®±
5. **æ¨¡å—åŒ–ç®¡ç†**ï¼šä½¿ç”¨Router/Service/peposåˆ†ç¦»ç®¡ç†
6. **å†…ç½®ç”¨æˆ·æ¨¡å—**ï¼šå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥
7. **å†…ç½®éªŒè¯ç æ¨¡å—**ï¼šé€šè¿‡é‚®ä»¶æ¨¡å—å‘é€éªŒè¯ç ä¿å­˜

## å¯åŠ¨æœåŠ¡
`npm install` åˆå§‹åŒ–é¡¹ç›®
`npm run dev` å¯åŠ¨æœåŠ¡ï¼Œé»˜è®¤å¼€å¯HTTPç«¯å£ `3000` ä¸ WSç«¯å£`3000`ï¼Œå¦‚éœ€ä¿®æ”¹è¯·æŸ¥çœ‹ `/env` æ–‡ä»¶å¤¹ä¸­çš„ç¯å¢ƒå˜é‡ `PORT` å­—æ®µè¿›è¡Œä¿®æ”¹ã€‚

## æ‰“åŒ…
`npm run build` æ‰“åŒ…ã€‚æ‰“åŒ…å®Œæˆåå°†åœ¨æ ¹ç›®å½•ç”Ÿæˆ `dist` æ–‡ä»¶å¤¹ã€‚è¿›å…¥ `dist` æ–‡ä»¶å¤¹æ‰§è¡Œ `node index.js` æµ‹è¯•èƒ½å¦æ­£å¸¸å¯åŠ¨ã€‚


## æ–‡ä»¶è¯´æ˜
```bash
- src
  - public    é™æ€ç›®å½•
  - constants å¸¸é‡ç›®å½•ï¼ŒåŒ…å«ç¯å¢ƒå˜é‡é…ç½®ä¸å“åº”çŠ¶æ€ç 
  - repos     æ“ä½œæ•°æ®åº“ç›¸å…³
  - routers   è·¯ç”±APIé…ç½®
  - services  æœåŠ¡ï¼Œè·¯ç”±æ‰€å¯¹åº”çš„ä¸šåŠ¡æ“ä½œåœ¨è¿™é‡Œ
  - models    æ¨¡å—ï¼Œé€šå¸¸ç”¨äºç»™æœåŠ¡æ·»åŠ è¾…åŠ©ç±»ã€‚å¦‚å‚æ•°æ ¡éªŒå™¨
  - util      å·¥å…·ç±»å‡½æ•°
  - other     å…¶ä»–
  - types     tsç±»å‹

```

## æƒé™
åº”ç”¨å·²å…¨å±€å†…ç½®æƒé™è®¾ç½®ï¼Œåªéœ€åœ¨å¯¹åº”æ¥å£æ·»åŠ  `auth` å‡½æ•°å³å¯ã€‚å‚è€ƒï¼š
MTExpress\src\routes\modules\user\index.ts

```js
import auth from '@src/routes/middleware/auth';
// porst è¯·æ±‚ /test è·¯å¾„
userRouter.post(
  '/test',
  // è¯¥è·¯å¾„å¿…é¡»åŒ…å« user/email/password å­—æ®µï¼Œä¸”å­—æ®µç±»å‹å¿…é¡»ä¸ºæŒ‡å®šç±»å‹
  validate(['username', 'string']),
  validate(['age', 'number']),
  // auth ä¸ºç¨‹åºæ ¡éªŒtokenå‡½æ•°ï¼ŒåŠ å…¥åå¿…é¡»ä¼ å…¥æœ‰æ•ˆtokenæ‰èƒ½è¿›å…¥servers
  auth,
  // servers å‡½æ•°
  UserRoutes.register,
);
```

## å†…ç½®æ¥å£

### å…¨å±€å“åº”
```js
{
  code: 0,
  message: "å†…å®¹"
}
```

### å‘é€é‚®ä»¶
#### å…¨å±€é…ç½®
å¦‚éœ€ä½¿ç”¨è¯¥æ¨¡å—ï¼Œè¯·è‡³ `/env` æ–‡ä»¶ä¸­é…ç½®ç›¸å…³è®¾ç½®
```bash
## Email Configuration ##
# SMTP æœåŠ¡å™¨é…ç½®
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
# å‘ä»¶äººé‚®ç®±å’Œå¯†ç 
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
# å‘ä»¶äººæ˜¾ç¤ºåç§°
EMAIL_FROM=MTExpress <your-email@gmail.com>
```

#### å‘é€éªŒè¯ç 
- `post` /verification/send
- `body`
  - email `string` `æ”¶ä»¶äºº`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - éªŒè¯ç å­˜å‚¨äº /repos/db æ–‡ä»¶å¤¹
  - æˆåŠŸè¿”å›
  ```js
  {
    "code": 0,
    "message": "éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶",
    "email": "xx@xx.com"
  }
  ```

#### æ¶ˆè´¹éªŒè¯ç 
éªŒè¯é‚®ç®± + éªŒè¯ç æ˜¯å¦åŒ¹é…ä¸”æœªè¿‡æœŸ
- `post` /verification/verify
- `body`
  - email `string` `æ”¶ä»¶äºº`
  - code `string` `éªŒè¯ç `

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - ç§»é™¤éªŒè¯ç 
  - æˆåŠŸè¿”å›
  ```js
  {
    "valid": true,
    "message": "éªŒè¯æˆåŠŸ"
  }
  ```

### æ–‡ä»¶ä¸Šä¼ 
#### ä¸Šä¼ å•ä¸ªæ–‡ä»¶
- `post` /upload
- `header`
  - Authorization `Bearer Token`
- `Content-Type`: `multipart/form-data`
- `form-data`
  - file `file` `æ–‡ä»¶`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æ•°æ®å­˜å‚¨äº /repos/db æ–‡ä»¶å¤¹
  - æ–‡ä»¶å­˜å‚¨äº uploads æ–‡ä»¶å¤¹
  - æˆåŠŸè¿”å›
  ```js
  {
    "id": 1,
    // æºæ–‡ä»¶å
    "originalName": "avatar.jpg",
    // æœåŠ¡ç«¯æ–‡ä»¶å
    "storedName": "20251102_1762050024918_1236.jpg",
    // æœåŠ¡ç«¯æ–‡ä»¶è·¯å¾„
    "filePath": "/uploads/20251102_1762050024918_1236.jpg",
    // æ–‡ä»¶å¤§å°
    "fileSize": 53886,
    // æ–‡ä»¶ç±»å‹
    "mimeType": "image/jpeg",
    // ä¸Šä¼ æ—¶é—´
    "uploadTime": "2025/11/2 10:20:24"
  }
  ```


#### è·å–æˆ‘çš„ä¸Šä¼ åˆ—è¡¨
- `get` /upload/list
- `header`
  - Authorization `Bearer Token`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æˆåŠŸè¿”å›
  ```js
  {
    "code": 0,
    "uploads": [
        {
        "id": 1,
        // æºæ–‡ä»¶å
        "originalName": "avatar.jpg",
        // æœåŠ¡ç«¯æ–‡ä»¶å
        "storedName": "20251102_1762050024918_1236.jpg",
        // æœåŠ¡ç«¯æ–‡ä»¶è·¯å¾„
        "filePath": "/uploads/20251102_1762050024918_1236.jpg",
        // æ–‡ä»¶å¤§å°
        "fileSize": 53886,
        // æ–‡ä»¶ç±»å‹
        "mimeType": "image/jpeg",
        // ä¸Šä¼ æ—¶é—´
        "uploadTime": "2025/11/2 10:20:24"
      },
      // ...
    ]
  }
  ```


#### é€šè¿‡æ–‡ä»¶idè·å–å•ä¸ªä¸Šä¼ è®°å½•
åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¸Šä¼ è®°å½•
- `get` /upload/:id
- `header`
  - Authorization `Bearer Token`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æˆåŠŸè¿”å›
  ```js
  {
    "code": 0,
    "uploads": {
      "id": 1,
      // æºæ–‡ä»¶å
      "originalName": "avatar.jpg",
      // æœåŠ¡ç«¯æ–‡ä»¶å
      "storedName": "20251102_1762050024918_1236.jpg",
      // æœåŠ¡ç«¯æ–‡ä»¶è·¯å¾„
      "filePath": "/uploads/20251102_1762050024918_1236.jpg",
      // æ–‡ä»¶å¤§å°
      "fileSize": 53886,
      // æ–‡ä»¶ç±»å‹
      "mimeType": "image/jpeg",
      // ä¸Šä¼ æ—¶é—´
      "uploadTime": "2025/11/2 10:20:24"
    }
  }
  ```



#### é€šè¿‡æ–‡ä»¶idåˆ é™¤ä¸Šä¼ è®°å½•
åªèƒ½åˆ é™¤è‡ªå·±çš„ä¸Šä¼ è®°å½•
- `delete` /upload/:id
- `header`
  - Authorization `Bearer Token`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - ä¸åˆ é™¤æ–‡ä»¶
  - åªåˆ é™¤æ•°æ®
  - æˆåŠŸè¿”å›
  ```js
  {
    "code": 0,
    "message": "åˆ é™¤æˆåŠŸ"
  }
  ```


### ç”¨æˆ·æ¥å£ /user

#### ç”¨æˆ·ä¿¡æ¯
```ts
{
  // å”¯ä¸€id
  id: number;
  // ç”¨æˆ·æ˜µç§°
  username: string;
  // é‚®ç®±
  email: string;
  // ç™»å½•å¯†ç 
  password: string;
  // å¯é€‰å¯†ç /éªŒè¯ç å­—æ®µï¼ˆregister æ—¶ä¼ å…¥ï¼‰
  code?: string;
  // å¤´åƒ
  avatar?: string | null;
  // åˆ›å»º/æ›´æ–°æ—¶é—´
  created: Date | string;
  updated?: Date | string | null;
  // å½“å‰ token ä¸è¿‡æœŸæ—¶é—´ï¼ˆms æ—¶é—´æˆ³ï¼‰
  token?: string | null;
  tokenExpiresAt?: number | null;
  // æœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´ï¼ˆms æ—¶é—´æˆ³ï¼‰
  lastActiveAt?: number | null;
}

```

#### æ·»åŠ ç”¨æˆ· 
- `post` /user/register 
- `body`
  - username `string` `ç”¨æˆ·å`
  - password `string` `å¯†ç ` (æ˜æ–‡ -> å“ˆå¸Œ)
  - email `string` `é‚®ç®±`
  - avatar `stringå¯é€‰` `å¤´åƒ` `åç»­æ”¹ä¸ºfile ç›´æ¥å­˜æ–‡ä»¶è·¯å¾„`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - å­˜å‚¨ç”¨æˆ·æ•°æ®
  ```js
  {
      "id": 0,
      "username": "zhangsan",
      "email": "123@163.com",
      "password": "12345678",
      "avatar": "**.jpg",
      "created": "1990/01/01 12:00:00",
      "updated": null,
      "token": null,
      "tokenExpiresAt": null,
      "lastActiveAt": null
    }
  ```

  
#### ç™»å½•
- `post` /user/login 
- `body`
  - username `string` `ç”¨æˆ·IDæˆ–é‚®ç®±`
  - password `string` `å¯†ç `

- ç™»å½•æˆåŠŸè¡Œä¸º
  - jsonwebtoken ç”Ÿæˆtokenä¸å­˜å‚¨
  - æ¥å£è¿”å›
  ```js
  {
    "code": 0,
    "token": "",
    "expiresAt": 0,
    "user": {} // ç”¨æˆ·ä¿¡æ¯
  }
  ```


#### æ›´æ–°ç”¨æˆ· 
ä»…å…è®¸è‡ªå·±æ›´æ–°è‡ªå·±
- `put` /user/update 
- `header`
  - Authorization `Bearer Token`
- `body`
  - id `number` `ç”¨æˆ·id`
  - username `stringå¯é€‰` `ç”¨æˆ·å`
  - password `stringå¯é€‰` `å¯†ç `
  - email `stringå¯é€‰` `é‚®ç®±`
  - avatar `stringå¯é€‰` `å¤´åƒ`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æ›´æ–°ç”¨æˆ·æ•°æ®
  - æ¥å£è¿”å›
  ```js
  {
    "code": 0,
    "message": "æ›´æ–°æˆåŠŸ"
  }
  ```

#### ç”¨æˆ·æ³¨é”€ 
ä»…å…è®¸æ³¨é”€è‡ªå·±
- `delete` /user/delete 
- `header`
  - Authorization `Bearer Token`
- `param`
  - id `number` `ç”¨æˆ·id`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æ›´æ–°ç”¨æˆ·æ•°æ®
  - æ¥å£è¿”å›
  ```js
  {
    "code": 0,
    "message": "æ³¨é”€æˆåŠŸ"
  }
  ```

#### æ£€éªŒtokenæ˜¯å¦æœ‰æ•ˆ
æ£€éªŒtokenæ˜¯å¦æœ‰æ•ˆ
- `post` /users/validate-token
- `header`
  - Authorization `Bearer Token`
- `body`
  - id `token` `æ— éœ€ Bearerçš„Token`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æ¥å£è¿”å›
  ```js
  {
    "code": 0,
    "valid": true,
    "payload": {
        "id": 0,
        "email": "xxx",
        "iat": 0,
        "exp": 0
    },
    "user": {}
  }
  ```

#### åˆ·æ–°token
ä»…åˆ·æ–°è‡ªå·±
- `post` /users/validate-token
- `header`
  - Authorization `Bearer Token`

- æ·»åŠ æˆåŠŸè¡Œä¸º
  - æ¥å£è¿”å›
  ```js
  {
    "code": 0,
    "token": "",
    "expiresAt": 0
  }
  ```

## WebSocket 

### åŠŸèƒ½ç‰¹æ€§

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæŒ‰ç…§é¡¹ç›®ç°æœ‰çš„æ¨¡å—åŒ–ç»“æ„ç»„ç»‡
2. **å¿ƒè·³æ£€æµ‹**ï¼šæ”¯æŒå¿ƒè·³æ£€æµ‹ä¸æˆ¿é—´é€šä¿¡
3. **å®æ—¶é€šä¿¡**ï¼šæ”¯æŒæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„åŒå‘é€šä¿¡
4. **æ¶ˆæ¯å¹¿æ’­**ï¼šæ”¯æŒå‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯
5. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### HTTP æ¥å£
#### è·å– WebSocket çŠ¶æ€
- `get` /ws/status

- å“åº”ç¤ºä¾‹
```json
{
  "code": 0,
  "total": 0,  // æ€»æ•°
  "active": 0, // åœ¨çº¿
  "rooms": {   // å·²å¼€å¯çš„æˆ¿é—´
      "2": 1
  },
  "connections": 0,
  "message": "WebSocket æœåŠ¡è¿è¡Œä¸­"
}
```

### WS æ¥å£
åŸºç¡€é“¾æ¥åœ°å€ `ws://localhost:3000/ws`

#### å‘é€ç»™æŒ‡å®šäºº
```js
import ConnectionManager from '@/ws/ConnectionManager';
// ç”¨æˆ·idï¼Œç”±uuidç”Ÿæˆ
ConnectionManager.sendToClient("ç”¨æˆ·id", {
  // MessageType.ERROR ä¸ºæšä¸¾ç±»å‹ï¼Œæœ‰å„ç§æ¶ˆæ¯ç±»å‹
  type: MessageType.ERROR,
  data: { message: 'å‘é€å¤±è´¥' },
});
```

#### å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
```ts
import WebSocketService from '@src/services/WebSocketService';
WebSocketService.broadcast({
  type: 'notification',
  message: 'ç³»ç»Ÿé€šçŸ¥',
  timestamp: new Date().toISOString()
});
```

#### åŠ å…¥æˆ¿é—´
```ts
import ConnectionManager from '@/ws/ConnectionManager';
ConnectionManager.joinRoom('äººå‘˜id', 'æˆ¿é—´å·');
```

#### å¹¿æ’­ç»™æŒ‡å®šæˆ¿é—´
```ts
ConnectionManager.broadcastToRoom(
  "æˆ¿é—´ID",
  {
    // æˆ¿é—´æ¶ˆæ¯
    type: MessageType.ROOM_MESSAGE,
    // æ¶ˆæ¯ä½“
    data: message.data,
    // å‘é€è€…
    from: clientId,
  },
  // æ’é™¤å‘é€è€…
  [clientId]
)
```

#### ç¦»å¼€æˆ¿é—´
```ts
import ConnectionManager from '@/ws/ConnectionManager';
ConnectionManager.leaveRoom(clientId, message.room);
```

### WS æµ‹è¯•
å¯åŠ¨æœåŠ¡å è®¿é—® `/src/public/ws-advanced-test.html` æ–‡ä»¶æµ‹è¯•åŠŸèƒ½